version: '3.8'

services:
  # RAG MCP Server for testing
  rag-mcp-test:
    build:
      context: ..
      dockerfile: Dockerfile.pi
    container_name: rag-mcp-test
    volumes:
      # Production memory volumes (mapped to test directories)
      - ./data/test_memory:/app/data
      - ./data/test_semantic_index:/app/data/semantic_index
      - ./data/test_episodic.db:/app/data/episodic.db
      # Test output and metrics
      - ./test_output:/app/test_output
    environment:
      - RAG_DATA_DIR=/app/data
      - LOG_LEVEL=DEBUG
      - ENABLE_METRICS=true
      - ENABLE_DEBUG_LOGS=true
      - PYTHONUNBUFFERED=1
    ports:
      - "8001:8001"
    cap_add:
      - SYS_ADMIN  # For failure simulation (chmod, volume manipulation)
    security_opt:
      - seccomp:unconfined  # Needed for chmod operations
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "from mcp.rag_server import server; import sys; sys.exit(0)"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Test metrics collection service
  test-collector:
    image: python:3.11-slim
    container_name: test-collector
    volumes:
      - ./test_output:/test_output
    working_dir: /test_output
    command: python -m http.server 8080
    ports:
      - "8080:8080"
    restart: unless-stopped

  # Load testing client (optional)
  test-client:
    image: python:3.11-slim
    container_name: test-client
    volumes:
      - ./test_output:/test_output
      - ./:/workspace
    working_dir: /workspace
    command: tail -f /dev/null
    profiles:
      - load-testing

volumes:
  test_memory:
    driver: local
  test_semantic_index:
    driver: local
  test_episodic.db:
    driver: local
