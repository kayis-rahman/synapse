version: '3.8'

services:
  pi-rag:
    # Build configuration
    build:
      context: .
      dockerfile: Dockerfile.pi
      # Enable BuildKit for faster builds
      # platforms:
      #   - linux/arm64
      #   - linux/arm/v8
      cache_from:
        - pi-rag:buildcache
      args:
        - BUILDKIT_INLINE_CACHE=1
    
    # Container identification
    image: pi-rag:latest
    container_name: pi-rag
    
    # Deployment configuration
    restart: unless-stopped
    
    # Resource limits for Raspberry Pi 5 (8GB RAM)
    # Adjust based on your Pi model and usage
    deploy:
      resources:
        limits:
          cpus: '3.0'  # Pi 5 has 4 cores, leaving 1 for OS
          memory: 3G   # Leave ~5GB for OS and other services
        reservations:
          cpus: '0.5'
          memory: 512M
    
    # Port mapping - API accessible on host port 8001
    ports:
      - "8001:8001"
    
    # Environment configuration
    environment:
      # RAG Configuration
      - RAG_CONFIG=/app/configs/rag_config.json
      - RAG_HOST=0.0.0.0
      - RAG_PORT=8001
      
      # Python configuration
      - PYTHONUNBUFFERED=1
      - PYTHONPATH=/app
      
      # External API configuration (override in .env or secrets)
      - EXTERNAL_CHAT_API_URL=${EXTERNAL_CHAT_API_URL:-}
      - EXTERNAL_CHAT_API_KEY=${EXTERNAL_CHAT_API_KEY:-}
    
    # Volume mounts for persistence and configuration
    volumes:
      # Configurations - bind mount for easy editing
      - type: bind
        source: ./configs
        target: /app/configs
        read_only: true
      
      # Models - named volume for GGUF files (100s of MB)
      - type: volume
        source: pi-rag-models
        target: /app/models
      
      # Data - named volume for vector store and documents
      - type: volume
        source: pi-rag-data
        target: /app/data
      
      # Cache volumes for better performance
      - type: volume
        source: pi-rag-cache
        target: /home/pireader/.cache
      
      - type: volume
        source: pi-rag-huggingface
        target: /home/pireader/.huggingface
    
    # Network configuration
    networks:
      - pi-rag-net
    
    # Health check
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

# Named volumes for persistence
volumes:
  pi-rag-models:
    driver: local
    # Optional: specify driver options for performance
    # driver_opts:
    #   type: none
    #   o: bind
    #   device: /home/pi/pi-rag-models
  
  pi-rag-data:
    driver: local
  
  pi-rag-cache:
    driver: local
  
  pi-rag-huggingface:
    driver: local

# Custom network
networks:
  pi-rag-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
